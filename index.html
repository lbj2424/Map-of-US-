<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>The Map of Us</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css" type="text/css">

    <style>
        body { margin: 0; padding: 0; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        
        /* The "Add Memory" Button */
        #add-mode-btn {
            position: absolute; bottom: 40px; right: 30px;
            background: #ff4757; color: white; padding: 15px 30px;
            border-radius: 50px; cursor: pointer; font-weight: bold; font-size: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4); z-index: 10;
            transition: all 0.2s ease;
        }
        #add-mode-btn:hover { transform: scale(1.05); background: #ff6b81; }

        /* The Form Modal */
        #memory-modal {
            display: none; position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%); width: 90%; max-width: 320px;
            background: white; padding: 25px; border-radius: 15px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); z-index: 20;
            max-height: 90vh; overflow-y: auto; /* Scroll if tall */
        }
        #memory-modal h3 { margin-top: 0; color: #333; }
        
        /* Inputs */
        input[type="text"], textarea, input[type="date"] { 
            width: 100%; margin-bottom: 15px; padding: 10px; 
            box-sizing: border-box; border: 1px solid #ddd; border-radius: 8px;
            font-family: inherit;
        }
        
        /* Hide file input during edit mode */
        .file-input-container { margin-bottom: 15px; }
        
        /* Buttons */
        button#save-btn { 
            background: #2ed573; color: white; border: none; padding: 12px; 
            width: 100%; cursor: pointer; border-radius: 8px; font-weight: bold; font-size: 14px;
        }
        button#cancel-btn {
            background: transparent; color: #888; border: none; padding: 10px;
            width: 100%; cursor: pointer; margin-top: 5px; font-size: 12px;
        }

        /* Popup Styling */
        .mapboxgl-popup { max-width: 300px !important; z-index: 15; }
        .mapboxgl-popup-content { padding: 15px; border-radius: 12px; max-height: 400px; overflow-y: auto; }
        .popup-img { width: 100%; border-radius: 8px; margin-top: 8px; display: block; }
        .popup-date { font-size: 12px; color: #888; margin-bottom: 5px; display: block; font-weight: bold; }
        .popup-story { font-size: 14px; line-height: 1.5; color: #333; margin-bottom: 10px; }
        
        /* Edit/Delete Actions */
        .popup-actions { margin-top: 15px; border-top: 1px solid #eee; padding-top: 10px; text-align: right; }
        .action-btn { background: none; border: none; cursor: pointer; font-size: 12px; padding: 5px 10px; border-radius: 4px; }
        .edit-btn { color: #3742fa; }
        .edit-btn:hover { background: #f1f2f6; }
        .delete-btn { color: #ff4757; }
        .delete-btn:hover { background: #ffeaa7; }

        /* Custom Photo Marker Styling */
        .custom-marker {
            width: 50px; height: 50px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.4);
            background-size: cover; background-position: center;
            cursor: pointer; transition: transform 0.2s;
        }
        .custom-marker:hover { transform: scale(1.2); z-index: 99; }
    </style>
</head>
<body>

<div id="map"></div>
<div id="add-mode-btn">+ Add Memory</div>

<div id="memory-modal">
    <h3 id="modal-title">‚ù§Ô∏è Add a Memory</h3>
    
    <label style="font-size:12px; color:#666;">Title:</label>
    <input type="text" id="title" placeholder="e.g. Empire State Building">
    
    <label style="font-size:12px; color:#666;">Date:</label>
    <input type="date" id="date-input">

    <label style="font-size:12px; color:#666;">Story:</label>
    <textarea id="story" rows="4" placeholder="Type your story here..."></textarea>
    
    <div class="file-input-container" id="file-container">
        <label style="font-size:12px; color:#666; display:block; margin-bottom:5px;">Select Photos:</label>
        <input type="file" id="photo-input" multiple accept="image/*">
    </div>

    <button id="save-btn">Save Memory</button>
    <button id="cancel-btn" onclick="closeModal()">Cancel</button>
</div>

<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";

    // --- FIREBASE CONFIG ---
    const firebaseConfig = {
      apiKey: "AIzaSyD__85oYqn2rBgEdWYAG9qF8NzRROtVF-4",
      authDomain: "map-of-us-d3536.firebaseapp.com",
      projectId: "map-of-us-d3536",
      storageBucket: "map-of-us-d3536.firebasestorage.app",
      messagingSenderId: "121698876853",
      appId: "1:121698876853:web:6bbff8558ad0b53d48adfc",
      measurementId: "G-S3H9V021M6"
    };

    // --- MAPBOX KEYS ---
    mapboxgl.accessToken = 'pk.eyJ1IjoibHVrZWxiaiIsImEiOiJjbWxmdWV4bmwwNjF4M2dvcm1qcms1bGZ3In0.cBF38tj67qY4vvRoCPm_2A';
    const MAP_STYLE = 'mapbox://styles/mapbox/streets-v12'; 
    // -------------------

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const map = new mapboxgl.Map({
        container: 'map',
        style: MAP_STYLE,
        center: [-98.5795, 39.8283],
        zoom: 3.5
    });
    map.addControl(new mapboxgl.NavigationControl());
    
    // --- UPDATED SEARCH BAR (With Types) ---
    const geocoder = new MapboxGeocoder({
        accessToken: mapboxgl.accessToken,
        mapboxgl: mapboxgl,
        marker: false,
        placeholder: 'Search for places...',
        // This line fixes the search to find POIs (Points of Interest)
        types: 'poi,address,place,locality,neighborhood'
    });
    map.addControl(geocoder, 'top-left');

    // --- STATE VARIABLES ---
    let isAddingMode = false;
    let editingId = null; 
    let tempLngLat = null;
    let localMemories = {}; 

    const modal = document.getElementById('memory-modal');
    const addBtn = document.getElementById('add-mode-btn');
    const saveBtn = document.getElementById('save-btn');
    const modalTitle = document.getElementById('modal-title');
    const fileContainer = document.getElementById('file-container');
    const dateInput = document.getElementById('date-input');

    // 1. Toggle "Add Mode"
    addBtn.addEventListener('click', () => {
        isAddingMode = !isAddingMode;
        if (isAddingMode) {
            addBtn.innerText = "üëá Click a location on the map";
            addBtn.style.background = "#ffa502";
        } else {
            resetUI();
        }
    });

    // 2. Click Map to Open Form
    map.on('click', (e) => {
        if (!isAddingMode) return;
        tempLngLat = e.lngLat;
        openModal(); 
    });

    // 3. Save Logic (Handles BOTH New and Edit)
    saveBtn.addEventListener('click', async () => {
        const title = document.getElementById('title').value;
        const story = document.getElementById('story').value;
        const dateVal = document.getElementById('date-input').value;
        const files = document.getElementById('photo-input').files;

        if (!title) return alert("Please add a title!");

        saveBtn.innerText = "Saving..."; 
        saveBtn.disabled = true;

        // Use selected date OR today's date if empty
        const finalDate = dateVal ? new Date(dateVal).toISOString() : new Date().toISOString();

        try {
            // CASE A: EDITING
            if (editingId) {
                const memoryRef = doc(db, "memories", editingId);
                await updateDoc(memoryRef, {
                    title: title,
                    story: story,
                    date: finalDate // Update date
                });
                alert("Memory updated!");
            } 
            // CASE B: NEW MEMORY
            else {
                let imageUrls = [];
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const fileName = `memories/${Date.now()}-${file.name}`;
                    const storageRef = ref(storage, fileName);
                    await uploadBytes(storageRef, file);
                    const url = await getDownloadURL(storageRef);
                    imageUrls.push(url);
                }

                await addDoc(collection(db, "memories"), {
                    lat: tempLngLat.lat,
                    lng: tempLngLat.lng,
                    title: title,
                    story: story,
                    images: imageUrls,
                    date: finalDate // Save date
                });
                alert("Memory saved! ‚ù§Ô∏è");
            }

            closeModal();
            loadMarkers(); 
        } catch (e) {
            console.error("Error:", e);
            alert("Something went wrong: " + e.message);
            saveBtn.innerText = "Save";
            saveBtn.disabled = false;
        }
    });

    // 4. Global Functions
    window.deleteMemory = async (id) => {
        if (confirm("Are you sure you want to delete this memory?")) {
            try {
                await deleteDoc(doc(db, "memories", id));
                loadMarkers(); 
            } catch (e) {
                alert("Error deleting: " + e.message);
            }
        }
    };

    window.editMemory = (id) => {
        const data = localMemories[id];
        if (!data) return;

        editingId = id; 
        
        // Populate Form
        document.getElementById('title').value = data.title;
        document.getElementById('story').value = data.story;
        
        // Populate Date (Format YYYY-MM-DD)
        if (data.date) {
            document.getElementById('date-input').value = data.date.split('T')[0];
        } else {
            document.getElementById('date-input').value = '';
        }
        
        fileContainer.style.display = 'none';
        openModal(true); 
    };

    // 5. Load Markers
    async function loadMarkers() {
        const existing = document.querySelectorAll('.mapboxgl-marker');
        existing.forEach(e => e.remove());

        const querySnapshot = await getDocs(collection(db, "memories"));
        
        querySnapshot.forEach((docSnap) => {
            const data = docSnap.data();
            const id = docSnap.id;
            localMemories[id] = data;

            let imagesHtml = '';
            let markerElement;

            if (data.images && data.images.length > 0) {
                data.images.forEach(url => {
                    imagesHtml += `<img src="${url}" class="popup-img">`;
                });
                const el = document.createElement('div');
                el.className = 'custom-marker';
                el.style.backgroundImage = `url(${data.images[0]})`;
                markerElement = new mapboxgl.Marker(el);
            } else {
                markerElement = new mapboxgl.Marker({ color: "#ff4757", scale: 0.8 });
            }

            // Clean Date for display
            const dateStr = data.date ? new Date(data.date).toLocaleDateString() : '';

            const popupContent = `
                <h3>${data.title}</h3>
                <span class="popup-date">${dateStr}</span>
                <div class="popup-story">${data.story}</div>
                ${imagesHtml}
                <div class="popup-actions">
                    <button class="action-btn edit-btn" onclick="window.editMemory('${id}')">‚úèÔ∏è Edit</button>
                    <button class="action-btn delete-btn" onclick="window.deleteMemory('${id}')">üóëÔ∏è Delete</button>
                </div>
            `;

            markerElement
                .setLngLat([data.lng, data.lat])
                .setPopup(new mapboxgl.Popup({ offset: 25 }).setHTML(popupContent))
                .addTo(map);
        });
    }

    function openModal(isEdit = false) {
        modal.style.display = 'block';
        if (isEdit) {
            modalTitle.innerText = "‚úèÔ∏è Edit Memory";
            saveBtn.innerText = "Update Memory";
        } else {
            modalTitle.innerText = "‚ù§Ô∏è Add a Memory";
            saveBtn.innerText = "Save Memory";
            fileContainer.style.display = 'block';
            
            // Default date to today for new memories
            document.getElementById('date-input').valueAsDate = new Date();
        }
        isAddingMode = false;
        addBtn.innerText = "+ Add Memory";
        addBtn.style.background = "#ff4757";
    }

    window.closeModal = () => {
        modal.style.display = 'none';
        resetUI();
    }

    function resetUI() {
        editingId = null;
        document.getElementById('title').value = '';
        document.getElementById('story').value = '';
        document.getElementById('date-input').value = '';
        document.getElementById('photo-input').value = '';
        saveBtn.innerText = "Save Memory";
        saveBtn.disabled = false;
        fileContainer.style.display = 'block';
        isAddingMode = false;
        addBtn.innerText = "+ Add Memory";
        addBtn.style.background = "#ff4757";
    }

    loadMarkers();

</script>

</body>
</html>

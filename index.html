<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>The Map of Us</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css" type="text/css">

    <style>
        body { margin: 0; padding: 0; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; background: #f9f9f9; }
        
        /* View Containers */
        #map-view { position: absolute; top: 0; bottom: 0; width: 100%; }
        #list-view { 
            display: none; padding: 80px 20px 20px 20px; 
            max-width: 800px; margin: 0 auto; background: #f9f9f9; min-height: 100vh;
        }

        /* Toggle Button */
        #view-toggle-btn {
            position: fixed; top: 20px; right: 20px;
            background: white; padding: 12px 24px;
            border-radius: 30px; cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            font-weight: bold; z-index: 100; font-size: 16px;
            border: 2px solid #333; transition: all 0.2s;
        }
        #view-toggle-btn:hover { background: #333; color: white; }

        /* Add Button */
        #add-mode-btn {
            position: fixed; bottom: 40px; right: 30px;
            background: #ff4757; color: white; padding: 15px 35px;
            border-radius: 50px; cursor: pointer; font-weight: bold; font-size: 18px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4); z-index: 100;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        #add-mode-btn:hover { transform: scale(1.05); background: #ff6b81; }

        /* --- SEARCH BAR TWEAKS --- */
        .mapboxgl-ctrl-geocoder {
            min-width: 400px !important; /* Wider search bar */
            box-shadow: 0 4px 15px rgba(0,0,0,0.1) !important;
            border-radius: 20px !important;
            font-size: 16px !important;
        }

        /* --- POPUP STYLING (THE BIG UPGRADE) --- */
        .mapboxgl-popup { 
            max-width: 900px !important; /* Huge width for desktop */
            width: 80% !important; /* Takes up most of the screen width if needed */
        }
        
        .mapboxgl-popup-content { 
            padding: 30px; border-radius: 15px; 
            max-height: 80vh; /* Allow it to get tall */
            overflow-y: auto; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
        }

        /* Popup Header */
        .mapboxgl-popup-content h3 {
            font-size: 32px; margin-bottom: 5px; color: #2d3436;
        }
        .popup-date {
            font-size: 16px; color: #888; font-weight: 500; margin-bottom: 20px; display: block;
        }

        /* Popup Image Scroll Container - Bigger Photos */
        .popup-img-scroll {
            display: flex; gap: 15px; overflow-x: auto; 
            margin: 20px 0; padding-bottom: 15px; scroll-behavior: smooth;
        }
        .popup-img-item {
            height: 350px; /* HUGE photos */
            width: auto; border-radius: 10px; 
            cursor: pointer; transition: transform 0.2s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .popup-img-item:hover { transform: scale(1.02); }

        /* Popup Text */
        .popup-story { 
            font-size: 28px; /* Was 20px, bumped to 24px */
            line-height: 1.8; /* Increased spacing between lines */
            color: #444; 
            margin-top: 20px; 
            font-weight: 400; /* Regular weight, but you could try 500 for semi-bold */
        }

        /* --- MOBILE SPECIFIC FIXES (Keep it small on phones) --- */
        @media only screen and (max-width: 600px) {
            /* Reset popup size for phone */
            .mapboxgl-popup { max-width: 300px !important; width: auto !important; }
            .mapboxgl-popup-content h3 { font-size: 20px; }
            .popup-date { font-size: 12px; }
            .popup-img-item { height: 140px; } /* Smaller photos for phone */
            .popup-story { font-size: 14px; }
            
            /* Center the Add Button */
            #add-mode-btn {
                left: 50%; right: auto; transform: translateX(-50%);
                bottom: 30px; width: max-content; font-size: 14px; padding: 12px 25px;
            }
            /* Fix Search Bar */
            .mapboxgl-ctrl-top-left { width: 100%; top: 10px; }
            .mapboxgl-ctrl-geocoder { width: 90% !important; min-width: unset !important; margin: 0 auto !important; }
            /* Move Toggle Button */
            #view-toggle-btn {
                top: auto; bottom: 90px; right: 20px;
                padding: 8px 15px; font-size: 12px; background: rgba(255,255,255,0.95);
            }
        }

        /* List View Card Styling */
        .memory-card {
            background: white; border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            margin-bottom: 30px; overflow: hidden; animation: fadeIn 0.5s ease;
        }
        .memory-header { padding: 20px; border-bottom: 1px solid #eee; }
        .memory-date { color: #888; font-size: 12px; text-transform: uppercase; letter-spacing: 1px; }
        .memory-title { margin: 5px 0 0 0; font-size: 24px; color: #333; }
        .memory-img-container { width: 100%; overflow-x: auto; white-space: nowrap; padding-bottom: 5px; }
        .memory-card-img { display: inline-block; height: 350px; width: auto; margin-right: 5px; object-fit: cover; }
        .memory-body { padding: 25px; font-size: 18px; line-height: 1.6; color: #555; }
        .memory-footer { padding: 15px 20px; border-top: 1px solid #f5f5f5; text-align: right; }

        /* Modal & Helpers */
        #memory-modal {
            display: none; position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%); width: 90%; max-width: 400px;
            background: white; padding: 30px; border-radius: 15px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); z-index: 200;
            max-height: 90vh; overflow-y: auto;
        }
        input, textarea { width: 100%; margin-bottom: 15px; padding: 12px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 8px; font-family: inherit; font-size: 16px; }
        button#save-btn { background: #2ed573; color: white; border: none; padding: 15px; width: 100%; cursor: pointer; border-radius: 8px; font-weight: bold; font-size: 16px; }
        button#cancel-btn { background: transparent; color: #888; border: none; padding: 10px; width: 100%; cursor: pointer; margin-top: 5px; }
        .custom-marker { width: 55px; height: 55px; border-radius: 50%; border: 3px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.4); background-size: cover; background-position: center; cursor: pointer; }
        .action-btn { background: none; border: none; cursor: pointer; font-size: 14px; padding: 5px 10px; border-radius: 4px; }
        .edit-btn { color: #3742fa; } .delete-btn { color: #ff4757; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div id="view-toggle-btn">üìã List View</div>
<div id="add-mode-btn">+ Add Memory</div>

<div id="map-view"></div>

<div id="list-view">
    <h1 style="text-align:center; margin-bottom:40px; color:#333;">Our Story ‚ù§Ô∏è</h1>
    <div id="timeline-container"></div>
</div>

<div id="memory-modal">
    <h3 id="modal-title">‚ù§Ô∏è Add a Memory</h3>
    <label style="font-size:12px; color:#666;">Title:</label>
    <input type="text" id="title" placeholder="e.g. Empire State Building">
    <label style="font-size:12px; color:#666;">Date:</label>
    <input type="date" id="date-input">
    <label style="font-size:12px; color:#666;">Story:</label>
    <textarea id="story" rows="4" placeholder="Tell the story..."></textarea>
    <div class="file-input-container" id="file-container">
        <label style="font-size:12px; color:#666; display:block; margin-bottom:5px;">Select Photos:</label>
        <input type="file" id="photo-input" multiple accept="image/*">
    </div>
    <button id="save-btn">Save Memory</button>
    <button id="cancel-btn" onclick="closeModal()">Cancel</button>
</div>

<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, updateDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";

    // --- FIREBASE CONFIG ---
    const firebaseConfig = {
      apiKey: "AIzaSyD__85oYqn2rBgEdWYAG9qF8NzRROtVF-4",
      authDomain: "map-of-us-d3536.firebaseapp.com",
      projectId: "map-of-us-d3536",
      storageBucket: "map-of-us-d3536.firebasestorage.app",
      messagingSenderId: "121698876853",
      appId: "1:121698876853:web:6bbff8558ad0b53d48adfc",
      measurementId: "G-S3H9V021M6"
    };

    // --- MAPBOX CONFIG ---
    mapboxgl.accessToken = 'pk.eyJ1IjoibHVrZWxiaiIsImEiOiJjbWxmdWV4bmwwNjF4M2dvcm1qcms1bGZ3In0.cBF38tj67qY4vvRoCPm_2A';
    const MAP_STYLE = 'mapbox://styles/mapbox/streets-v12';

    // Init App
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const map = new mapboxgl.Map({
        container: 'map-view',
        style: MAP_STYLE,
        center: [-98.5795, 39.8283],
        zoom: 3.5
    });
    map.addControl(new mapboxgl.NavigationControl());
    
    // Search Bar
    const geocoder = new MapboxGeocoder({
        accessToken: mapboxgl.accessToken, mapboxgl: mapboxgl,
        marker: false, placeholder: 'Search places...',
        types: 'poi,address,place,locality,neighborhood'
    });
    map.addControl(geocoder, 'top-left');

    // --- VARIABLES ---
    let isAddingMode = false;
    let isListView = false;
    let editingId = null;
    let tempLngLat = null;
    let localMemories = {};

    // --- DOM ELEMENTS ---
    const modal = document.getElementById('memory-modal');
    const addBtn = document.getElementById('add-mode-btn');
    const toggleBtn = document.getElementById('view-toggle-btn');
    const mapView = document.getElementById('map-view');
    const listView = document.getElementById('list-view');
    const timelineContainer = document.getElementById('timeline-container');

    // 1. Toggle Map vs List
    toggleBtn.addEventListener('click', () => {
        isListView = !isListView;
        if (isListView) {
            mapView.style.display = 'none';
            listView.style.display = 'block';
            toggleBtn.innerText = "üó∫Ô∏è Map View";
            addBtn.style.display = 'none';
        } else {
            mapView.style.display = 'block';
            listView.style.display = 'none';
            toggleBtn.innerText = "üìã List View";
            addBtn.style.display = 'block';
            map.resize();
        }
    });

    // 2. Add Mode
    addBtn.addEventListener('click', () => {
        isAddingMode = !isAddingMode;
        if (isAddingMode) {
            addBtn.innerText = "üëá Click the Map";
            addBtn.style.background = "#ffa502";
        } else {
            resetUI();
        }
    });

    map.on('click', (e) => {
        if (!isAddingMode) return;
        tempLngLat = e.lngLat;
        openModal();
    });

    // 3. Save Logic
    document.getElementById('save-btn').addEventListener('click', async () => {
        const title = document.getElementById('title').value;
        const story = document.getElementById('story').value;
        const dateVal = document.getElementById('date-input').value;
        const files = document.getElementById('photo-input').files;
        const btn = document.getElementById('save-btn');

        if (!title) return alert("Title required!");
        btn.innerText = "Saving..."; btn.disabled = true;

        const finalDate = dateVal ? new Date(dateVal).toISOString() : new Date().toISOString();

        try {
            if (editingId) {
                await updateDoc(doc(db, "memories", editingId), {
                    title, story, date: finalDate
                });
            } else {
                let imageUrls = [];
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const refPtr = ref(storage, `memories/${Date.now()}-${file.name}`);
                    await uploadBytes(refPtr, file);
                    imageUrls.push(await getDownloadURL(refPtr));
                }
                await addDoc(collection(db, "memories"), {
                    lat: tempLngLat.lat, lng: tempLngLat.lng,
                    title, story, images: imageUrls, date: finalDate
                });
            }
            closeModal();
            loadMemories();
            alert("Saved!");
        } catch (e) {
            console.error(e);
            alert("Error: " + e.message);
            btn.innerText = "Save"; btn.disabled = false;
        }
    });

    // 4. Global Edit/Delete
    window.deleteMemory = async (id) => {
        if (confirm("Delete this memory?")) {
            await deleteDoc(doc(db, "memories", id));
            loadMemories();
        }
    };
    window.editMemory = (id) => {
        const data = localMemories[id];
        if (!data) return;
        editingId = id;
        document.getElementById('title').value = data.title;
        document.getElementById('story').value = data.story;
        document.getElementById('date-input').value = data.date ? data.date.split('T')[0] : '';
        document.getElementById('file-container').style.display = 'none';
        openModal(true);
    };

    // 5. Load Data
    async function loadMemories() {
        document.querySelectorAll('.mapboxgl-marker').forEach(e => e.remove());
        timelineContainer.innerHTML = '';

        const q = query(collection(db, "memories"), orderBy("date", "desc"));
        const querySnapshot = await getDocs(q);

        querySnapshot.forEach((docSnap) => {
            const data = docSnap.data();
            const id = docSnap.id;
            localMemories[id] = data;
            
            const dateObj = data.date ? new Date(data.date) : new Date();
            const dateStr = dateObj.toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' });

            // --- A. Render Map Pin ---
            let markerEl;
            if (data.images && data.images.length > 0) {
                const el = document.createElement('div');
                el.className = 'custom-marker';
                el.style.backgroundImage = `url(${data.images[0]})`;
                markerEl = new mapboxgl.Marker(el);
            } else {
                markerEl = new mapboxgl.Marker({ color: "#ff4757" });
            }
            
            // Build Popup Images HTML
            let popupImagesHtml = '';
            if (data.images && data.images.length > 0) {
                popupImagesHtml += '<div class="popup-img-scroll">';
                data.images.forEach(img => {
                    popupImagesHtml += `<img src="${img}" class="popup-img-item" onclick="window.open('${img}')">`;
                });
                popupImagesHtml += '</div>';
            }

            const popupHTML = `
                <h3>${data.title}</h3>
                <div style="font-size:12px; color:#888; margin-bottom:5px;">${dateStr}</div>
                ${popupImagesHtml}
                <p>${data.story}</p>
                <div style="text-align:right;">
                    <button class="action-btn edit-btn" onclick="editMemory('${id}')">Edit</button>
                    <button class="action-btn delete-btn" onclick="deleteMemory('${id}')">Delete</button>
                </div>
            `;
            
            markerEl.setLngLat([data.lng, data.lat])
                .setPopup(new mapboxgl.Popup({ offset: 25 }).setHTML(popupHTML))
                .addTo(map);

            // --- B. Render List Card ---
            let imagesListHtml = '';
            if (data.images) {
                data.images.forEach(img => {
                    imagesListHtml += `<img src="${img}" class="memory-card-img" onclick="window.open('${img}')">`;
                });
            }

            const card = document.createElement('div');
            card.className = 'memory-card';
            card.innerHTML = `
                <div class="memory-header">
                    <div class="memory-date">${dateStr}</div>
                    <h2 class="memory-title">${data.title}</h2>
                </div>
                <div class="memory-img-container">
                    ${imagesListHtml}
                </div>
                <div class="memory-body">
                    ${data.story}
                </div>
                <div class="memory-footer">
                    <button class="action-btn edit-btn" onclick="editMemory('${id}')">‚úèÔ∏è Edit</button>
                    <button class="action-btn delete-btn" onclick="deleteMemory('${id}')">üóëÔ∏è Delete</button>
                </div>
            `;
            timelineContainer.appendChild(card);
        });
    }

    function openModal(isEdit = false) {
        modal.style.display = 'block';
        document.getElementById('modal-title').innerText = isEdit ? "‚úèÔ∏è Edit Memory" : "‚ù§Ô∏è Add a Memory";
        document.getElementById('save-btn').innerText = isEdit ? "Update" : "Save";
        if (!isEdit) {
             document.getElementById('file-container').style.display = 'block';
             document.getElementById('date-input').valueAsDate = new Date();
        }
        isAddingMode = false;
        addBtn.innerText = "+ Add Memory";
        addBtn.style.background = "#ff4757";
    }
    window.closeModal = () => {
        modal.style.display = 'none';
        resetUI();
    }
    function resetUI() {
        editingId = null;
        document.getElementById('title').value = '';
        document.getElementById('story').value = '';
        document.getElementById('date-input').value = '';
        document.getElementById('photo-input').value = '';
        document.getElementById('save-btn').innerText = "Save";
        document.getElementById('save-btn').disabled = false;
        document.getElementById('file-container').style.display = 'block';
    }

    loadMemories();

</script>
</body>
</html>
